<!DOCTYPE html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>MPS Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/css/foundation.min.css"/>
  <link rel="stylesheet" href="/css/styles.css"/>

  <style>
    .ad-topbanner {
      width:728px;
      height:90px;
    }
    .right-boxad {
      width:300px;
      height:250px;
      padding:0;
    }
  </style>

  <script type="text/javascript">

  var mpsopts = {'host':'stage-mps.nbcuni.com'};

  var mpscall = {
    "cat": "TEST",
    "path": "TEST/refresh",
    "site": "sandbox",
    "content_id":"test-refresh"
  }

  var mps = mps || {};
  document.write('<scr'+'ipt id="mps-ext-load" src="//'+mpsopts.host+'/fetch/ext/load-'+mpscall.site+'.js"></scr'+'ipt>');

  </script>

  <script>
    /***** Ad Viewport Detection *****/
    mps._pending = [];
    mps._display = {
      render: function(s, a) {
        if(!s || !this.detect(s)) {
          var ad = {
            'elem': s,
            'ad': a
          }
          console.log('[MPS: DETECT DISPLAY]: Render, ad unit already pending: ' + this.pending(a));
          if(!this.pending(a)) {
            console.log('push ad to pending');
            mps._pending.push(ad);
          }
        } else {
          this.remove(a);
          mps.insertAd(s, a);
        }
      },
      log: function(log, show, perc) {
        var msg = '';
        switch(log) {
          case 'not_in_viewport':
            msg = 'Ad container not in viewport at all.  Show Ad:';
            break;
          case 'display':
            msg = perc + '% of the ad container is visible in the viewport.  Show Ad:';
            break;
        }
        console.log('[MPS: DETECT DISPLAY]: ' + msg + ' ' + show);
      },
      detect: function(s) {
        //TODO calculate padding and scrollbar width.
        var vp = mps._viewport(), vpW = vp[0], vpH = vp[1], elY = s.offsetTop,
        elX = s.offsetLeft, elW = s.offsetWidth, elH = s.offsetHeight,
        elA = elW * elH, scY = window.pageYOffset, scX = window.pageXOffset,
        showAd = false;

        // Not in viewport.
        if(scY >= (elY + elH) || scX >= (elX + elW)) { this.log('not_in_viewport', showAd); return showAd; }
        else {
          // Calculate portion of ad in viewport, 50% visible to show the ad.
          var widthShowing = ((vpW - elX) > elW) ? elW : vpW - elX;
          var heightShowing = ((vpH - elY) > elH) ? elH : vpH - elH;

          console.log('height showing without offset:' + heightShowing);
          console.log('width shwoing without offset: ' + widthShowing);

          // Adjust for offset if scrolling.
          if(scY > elY) { heightShowing = heightShowing - (scY - elY); }
          if(scX > 0) { widthShowing = (widthShowing + scX) > elW ? elW : widthShowing + scX; }

          console.log('height showing after offset subtracted:' + heightShowing);
          console.log('width shwoing after offset added: ' + widthShowing);

          console.log(widthShowing, heightShowing);
          var adShowing = widthShowing * heightShowing;

          adShowing >= (elA / 2) ? showAd = true : showAd = false;
          this.log('display', showAd, (adShowing / elA));
          return showAd;
        }
      },
      load: function() {
        // Check and load ads from event listener.
        var ads = mps._pending;
        if(ads.length > 0) {
          console.log('[MPS:DETECT PENDING ADS]: pending ads detected.');
          for(var i in ads) { mps._display.render(ads[i].elem, ads[i].ad); }
        }
      },
      pending: function(ad) {
        // Verify ad type is pending.
        for(var i in mps._pending) {
          if(mps._pending[i].ad === ad) {
            return true;
          }
        }
        return false;
      },
      remove: function(ad) {
        // Remove loaded ad from pending array, IE8 friendly.
        var pending = mps._pending;
        mps._pending = [];
        for(var i in pending) {
          if(pending[i].ad != ad) {
            mps._pending.push(pending[i]);
          }
        }
      }
    };

    // Add listeners.
    if(window.addEventListener) {
      window.addEventListener('scroll', mps._display.load, false);
      window.addEventListener('resize', mps._display.load, false);
    } else {
      // IE8.
      window.attachEvent('resize', mps._display.load, false);
      window.attachEvent('scroll', mps._display.load, false);
    }
    
  </script>

  <script>
    mps.gptloadCallback = function() {
      mps._display.render(mps._select('.top-banner'),'topbanner');
      mps._display.render(mps._select('.right-boxad'),'boxad');
    };
  </script>

</head>
<body>
<script>
  mps._ready(function(){
    var _adLoadCallbackExtend = mps._adloadCallback;
    mps._adloadCallback = function() {
      var args = arguments;
      var result = _adLoadCallbackExtend.apply(this, arguments);
      var _this = args[0];
      if(_this._mps._slot != '_oop') {
        document.getElementById('results').innerHTML += '<li>MPS <strong>' + _this._mps._slot + '</strong> ad code was loaded in <strong>' + _this._mps._elapsed + ' milliseconds</strong>.</li>';
      }

      return result;
    };
  });
</script>

<nav class="top-bar" data-topbar role="navigation">
  <ul class="title-area">
    <li class="name">
      <h1><a href="#">MPS Demo</a></h1>
    </li>
  </ul>
  <section class="top-bar-section">
    <ul class="right">
      <li><a href="/">Demo</a></li>
      <li><a href="/timing">Timing</a></li>
      <li><a href="/ad-block">Ad Block</a></li>
      <li><a href="/ad-block-ajax">Ad Block AJAX</a></li>
      <li><a href="/ad-scaling">Ad Scaling</a></li>
      <li><a href="/error-tracking">Error Tracking</a></li>
      <li class="active"><a href="/detect-display">Detect Display</a></li>
    </ul>
  </section>
</nav>

<div class="large-12 content m0auto center">
  <div class="top-banner ad-topbanner mt20 top-ad" id="top-banner"></div>
</div>

<div class="large-12 content m0auto">

  <div class="large-4 mt40 right">
    <div class="right-boxad panel p20 right"></div>
  </div>

  <div class="large-8">

    <div class="panel mt20"><ul id="results"></ul></div>

    <h1 class="mt20">MPS Detect Display</h1>

    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque tempus metus id accumsan vulputate. Nulla facilisis posuere libero, et laoreet nibh viverra et. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Cras a elit ac leo accumsan tristique. Vivamus pulvinar risus mauris. Ut eu elit porttitor, egestas massa a, consectetur mauris. Cras accumsan id justo a dapibus. Integer finibus dapibus leo eu accumsan. Nullam risus erat, molestie a mattis in, commodo vitae quam. Ut tempor diam est, sit amet luctus massa rhoncus nec. Nulla tempor vel magna quis ullamcorper. Maecenas urna purus, efficitur vel enim sed, vestibulum consequat libero. In non vehicula felis.<p>

    <p>Nam aliquam nec nulla ac luctus. Etiam hendrerit erat non mi congue, lacinia tincidunt massa commodo. Vestibulum nec tempus orci, eget mollis est. Vivamus vel nulla lobortis ipsum condimentum hendrerit vitae at ex. Donec mollis aliquet sollicitudin. Suspendisse quis sem nec ipsum lacinia euismod. Maecenas porta facilisis libero sed facilisis. Praesent fringilla cursus aliquet.</p>

    <p>Mauris risus nulla, porta eget leo in, vestibulum molestie eros. Phasellus eu odio turpis. Vestibulum erat sem, lacinia at odio id, tristique aliquam elit. Nulla a nisl vestibulum, faucibus magna vel, faucibus nunc. Maecenas velit felis, fringilla at ullamcorper nec, porttitor a dui. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Aliquam sed suscipit lectus. Integer et bibendum sapien, sit amet scelerisque diam. Pellentesque rhoncus leo a vestibulum semper. Sed fermentum congue nisl, at venenatis nisi dapibus ut. Aliquam vel mattis nisl.</p>

    <p>Aliquam nec sapien fringilla, ultricies quam et, pulvinar leo. Duis vehicula non libero ut ornare. Vivamus quis sapien quis purus mollis bibendum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Quisque auctor pulvinar tortor. Morbi sollicitudin eros vitae placerat ultricies. Etiam aliquet ornare magna. Nullam id nibh a ligula lacinia commodo. Cras maximus tincidunt est vel gravida. Curabitur lacinia ultrices ligula at facilisis. Mauris elementum consequat justo, faucibus faucibus enim efficitur id.</p>

    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque tempus metus id accumsan vulputate. Nulla facilisis posuere libero, et laoreet nibh viverra et. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Cras a elit ac leo accumsan tristique. Vivamus pulvinar risus mauris. Ut eu elit porttitor, egestas massa a, consectetur mauris. Cras accumsan id justo a dapibus. Integer finibus dapibus leo eu accumsan. Nullam risus erat, molestie a mattis in, commodo vitae quam. Ut tempor diam est, sit amet luctus massa rhoncus nec. Nulla tempor vel magna quis ullamcorper. Maecenas urna purus, efficitur vel enim sed, vestibulum consequat libero. In non vehicula felis.<p>

    <p>Nam aliquam nec nulla ac luctus. Etiam hendrerit erat non mi congue, lacinia tincidunt massa commodo. Vestibulum nec tempus orci, eget mollis est. Vivamus vel nulla lobortis ipsum condimentum hendrerit vitae at ex. Donec mollis aliquet sollicitudin. Suspendisse quis sem nec ipsum lacinia euismod. Maecenas porta facilisis libero sed facilisis. Praesent fringilla cursus aliquet.</p>

    <p>Mauris risus nulla, porta eget leo in, vestibulum molestie eros. Phasellus eu odio turpis. Vestibulum erat sem, lacinia at odio id, tristique aliquam elit. Nulla a nisl vestibulum, faucibus magna vel, faucibus nunc. Maecenas velit felis, fringilla at ullamcorper nec, porttitor a dui. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Aliquam sed suscipit lectus. Integer et bibendum sapien, sit amet scelerisque diam. Pellentesque rhoncus leo a vestibulum semper. Sed fermentum congue nisl, at venenatis nisi dapibus ut. Aliquam vel mattis nisl.</p>

    <p>Aliquam nec sapien fringilla, ultricies quam et, pulvinar leo. Duis vehicula non libero ut ornare. Vivamus quis sapien quis purus mollis bibendum. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae; Quisque auctor pulvinar tortor. Morbi sollicitudin eros vitae placerat ultricies. Etiam aliquet ornare magna. Nullam id nibh a ligula lacinia commodo. Cras maximus tincidunt est vel gravida. Curabitur lacinia ultrices ligula at facilisis. Mauris elementum consequat justo, faucibus faucibus enim efficitur id.</p>

  </div>

</div>

<footer>
  <div class="large-12 content m0auto">
    <hr />
    <p class="secondary">&copy; 2015, MPS.</p>
  </div>
  <script>typeof(mps.writeFooter)=='function' && mps.writeFooter();</script>
  <div class="footer-boxad"></div>
</footer>

</body>
</html>